name: DoT Circulars Daily Email

on:
  schedule:
    - cron: "0 3 * * *"   # 08:30 IST
  workflow_dispatch:

jobs:
  scrape-and-email:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show workspace
        run: |
          pwd
          ls -la

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Python version
        run: python -V

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run scraper (with verbose errors)
        run: |
          set -euxo pipefail
          python scraper.py
          echo "Scraper exit code: $?"

      - name: Check CSV exists and preview
        run: |
          ls -la
          test -f circulars.csv
          echo "First 5 lines:"
          head -n 5 circulars.csv || true

      - name: Upload CSV as artifact (always, even if email fails)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dot-circulars
          path: circulars.csv

      - name: Send email with CSV
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "DoT Circulars – Daily Report"
          to: ${{ secrets.RECEIVER_EMAIL }}
          from: "DoT Scraper Bot <${{ secrets.EMAIL_USER }}>"
          body: |
            Hi,
            Attached are last 10 DoT circulars (CSV).
            – Bhanu Tak
          attachments: circulars.csv
