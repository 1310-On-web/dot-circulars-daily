name: DoT Circulars Watcher (Hourly)

# on:
#   schedule:
#     - cron: "0 * * * *"   # every hour (UTC)
#   workflow_dispatch:

permissions:
  contents: write   # needed to commit the CSV back to the repo

jobs:
  watch-and-notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # so we can commit back

      - name: Show files (debug)
        run: |
          pwd
          ls -la
          find . -maxdepth 2 -type f

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install -r requirements.txt





      - id: scrape
        name: Run watcher with downloads & OpenAI summaries
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          # If you added OneDrive/Drive envs, keep them here as well
        run: |
          set -euxo pipefail
          python watch_dot_circulars.py
      
      # Only preview the email when there's something new
      - name: Show generated email preview
        if: steps.scrape.outputs.has_new == 'true'
        shell: bash
        run: |
          echo "---------- email_body.txt ----------"
          cat email_body.txt
          echo "------------------------------------"
      
      # Commit CSV/summaries only when new
      - name: Commit CSV changes (if any)
        if: steps.scrape.outputs.has_new == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/dot_circulars_master.csv data/summaries/*.txt || true
          git commit -m "Update DoT master CSV & summaries [skip ci]" || echo "No changes"
          git push || echo "No push"
      
      # Load email body only when new
      - id: load_body
        if: steps.scrape.outputs.has_new == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            core.setOutput('body', fs.readFileSync('email_body.txt','utf8'));

      - id: get_receivers
        name: Load recipients from file
        run: |
          # Remove empty lines and comments, join with commas
          recipients=$(grep -v '^#' receivers.txt | grep -v '^[[:space:]]*$' | paste -sd "," -)
          echo "recipients=$recipients" >> $GITHUB_OUTPUT


      
      # Send mail only when new
      - name: Send email (only when new)
        if: steps.scrape.outputs.has_new == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "DoT Circulars â€“ ${{ steps.scrape.outputs.subject_suffix }}"
          to: ${{ steps.get_receivers.outputs.recipients }}
          from: ${{ secrets.EMAIL_USER }}
          body: ${{ steps.load_body.outputs.body }}
      
        
